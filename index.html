<!DOCTYPE html>
<html lang="en">
<title>Contact Us</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
<style>
body {font-family: "Times New Roman", Georgia, Serif;}
h1, h2, h3, h4, h5, h6 {
  font-family: "Playfair Display";
  letter-spacing: 5px;
}
</style>
<body>

<!-- Navbar (sit on top) -->
<div class="w3-top">
  <div class="w3-bar w3-white w3-padding w3-card" style="letter-spacing:4px;">
     <!-- Right-sided navbar links. Hide them on small screens -->
    <div class="w3-right w3-hide-small">
    </div>
  </div>
</div>

<!-- Header -->
<header class="w3-display-container w3-content w3-wide" style="max-width:1600px;min-width:500px" id="home">
   <div class="w3-display-bottomleft w3-padding-large w3-opacity">
    <h1 class="w3-xxlarge">Contact</h1>
  </div>
</header>

<!-- Page content -->
<div class="w3-content" style="max-width:1100px">
  
  <hr>

  <!-- Contact Section -->
<form>

<div class="w3-container w3-padding-64" id="contact">
    <h1>We are here.</h1><hr><br>
    <p> You can leave a message, we'll get back to you within 24hours.</p>
    <p class="w3-text-blue-grey w3-large"><b></p><hr><br>
    <p></p>
    
      <p><input class="w3-input w3-padding-16" type="text" placeholder="Name" id="name" required name="Name"></p>
      <p><input class="w3-input w3-padding-16" type="email" placeholder="Email" id="mail" required name="Email"></p>
      <p><input class="w3-input w3-padding-16" type="text" placeholder="Message" id="message" required name="Message"></p>
      <p><button class="w3-button w3-light-grey w3-section" type="submit">SEND MESSAGE</button></p>
    </form>
  </div>
  
<!-- End page content -->
</div>

<!-- Footer -->
<footer class="w3-center w3-light-grey w3-padding-32">
  <p>Offices:<br> 42nd Living St, 43043 Accra, Ghana.<br> 108 Duplex Road, 110001 Nairobi, Kenya.<br> 9, Bishop Street, 120121 Ikeja, Lagos.</b></p> <br>
  <p>GADS 2020 <a href="https://gads.andela.com/" title="W3.CSS" target="_blank" class="w3-hover-text-green">Community Project</a></p>
</footer>
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.4.1/jquery.easing.min.js"</script>

<script>
const cryptoRandomString = require('crypto-random-string'); // Use Cryptographic Random String for Secret Key generation
const jwt = require('jsonwebtoken'); // Use JSON Web Token for Authentications
const nodemailer = require('nodemailer'); // Use Nodemailer for delivering messages between different email hosts as a protocol
const smtpTransport = require('nodemailer-smtp-transport'); // SMTP transport module for Nodemailer

const secretKey = cryptoRandomString({ length: 106, type: 'alphanumeric' });

const transporter = nodemailer.createTransport(smtpTransport({
    service: 'gmail',
    host: 'smtp.gmail.com',
    auth: {
        user: 'owambe.server@gmail.com',
        pass: 'server.owambe'
    }
}));

// Model Imports
const User = require('../models/user');



// API Routing Functions
exports.all = function(req, res) {
    User.find(function(error, users) {
        if (error) {
            return res.status(422).send('Sorry!! Your request could not be processed at the moment, please try again')
        } else {
            return res.json(users)
        }
    });
}

exports.update = function(req, res) {
    let userData = req.body

    User.findByIdAndUpdate(req.params._id, { $set: userData }, function(error, user) {
        if (error) {
            return res.status(422).send('Oops! Something went wrong with your update request')
        } else {
            return res.status(200).send(user)
        }
    });
}

exports.one = function(req, res) {
    User.findById(req.params._id, function(error, user) {
            if (error) {
                return res.status(404).send('Sorry!! The queried User could not be found or does not exist in our database')
            } else {
                return res.status(200).json(user)
            }
        }
    );
}

exports.register = function(req, res) {
    let userData = req.body

    // Presence Verification
    if (!userData.first_name) {
        return res.status(422).send('Please provide your First Name')
    }
    if (!userData.last_name) {
        return res.status(422).send('Please provide your Last Name')
    }
    if (!userData.email) {
        return res.status(422).send('Please provide your Email Address')
    }
    if (!userData.phone_number) {
        return res.status(422).send('Please provide your Phone Number')
    }
    if (!userData.country) {
        return res.status(422).send('Please provide your residential Country')
    }
    if (!userData.password) {
        return res.status(422).send('Please provide your Password')
    }

    // Password Verification
    if (userData.password != userData.password_confirmation) {
        return res.status(422).json('Password & Password Confirmation do not match')
    }

    // Registered User Check
    User.findOne({ email: userData.email }, function(error, registeredUser) {
        if (error) {
            return res.status(422).send('Oops! Something went wrong with your registration')
        }

        if (registeredUser) {
            return res.status(422).send('Sorry!! A User with this bio-data already exists.')
        } else {
            let user = new User(userData)
            user.save((error, registeredUser) => {
                if (error) {
                    console.log(error)
                } else {
                    let to = registeredUser.email
                    let subject = 'OWAMBE - ACCOUNT NUMBER NOTIFICATION'
                    let message = "Welcome to Owambe. Your unique account number for all transactionary purposes is: " + registeredUser._id

                    const mailOptions = {
                        from: 'owambe.server@gmail.com',
                        to: to,
                        subject: subject,
                        html: message
                    };

                    transporter.sendMail(mailOptions, function(error, info){
                        if (error) {
                            console.log(error);  
                        } else {     
                            console.log('Email sent: ' + info.response);  
                        }   
                    });

                    let payload = { subject: registeredUser._id }
                    let token = jwt.sign(payload, secretKey, { expiresIn: "1d" })
                    res.status(200).send({ token })
                }
            });
        }
    });
}

exports.login = function(req, res) {
    let userData = req.body

    // Presence Verification
    if (!userData._id) {
        return res.status(422).send('Please provide your Account Number')
    }
    if (!userData.password) {
        return res.status(422).send('Please provide your Password')
    }


    User.findOne({ _id: userData._id }, (error, user) => {
        if (error) {
            return res.status(422).send('Oops! Something went wrong. Please try again.')
        }

        if (!user) {
            return res.status(401).send('Sorry!! You do not have an account with us. You should consider registering first.')
        }

        if (!user.hasSamePassword(userData.password)) {
            return res.status(401).send('Invalid Password')
        } else {
            let payload = { subject: user._id }
            let token = jwt.sign(payload, secretKey, { expiresIn: "1d" })
            res.status(200).send({ token })
        }
    });
}

exports.delete = function(req, res) {
    User.findByIdAndRemove(req.params._id, function(error, result) {
        if (error) {
            return res.status(422).send('Oops! Something went wrong with your delete request')
        } else {
            return res.status(200).send('You have successfully deleted this user')
        }
    });
}
</body>
</html>


